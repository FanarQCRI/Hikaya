import { NextRequest, NextResponse } from 'next/server'
const FANAR_KEY = process.env.FANAR_API_KEY!

export async function POST(req: NextRequest)
{
    try
    {
        const { story, attempt = 1 } = await req.json()

        // Use different prompts based on attempt number
        let prompt: string
        
        if (attempt === 1) {
            // First attempt: comprehensive prompt
            prompt = `
اقرأ القصة العربية التالية بعناية:

${story}

أنشئ بالضبط ٥ أسئلة اختيار من متعدد باللغة العربية. كل سؤال يجب أن يكون عن معلومة مذكورة بوضوح في القصة.

**قواعد صارمة جداً:**
1. أنشئ بالضبط ٥ أسئلة - لا أكثر ولا أقل
2. كل سؤال يجب أن يكون عن معلومة موجودة نصياً في القصة
3. الإجابة الصحيحة يجب أن تكون مذكورة حرفياً في القصة
4. جميع الخيارات الخاطئة يجب أن تكون منطقية ولكن خاطئة بوضوح
5. لا تخترع أي معلومات غير موجودة في القصة
6. ركز على الحقائق المذكورة صراحةً: الأسماء، الأماكن، الأحداث، الألوان، الأرقام

**أنواع الأسئلة المطلوبة (٥ أسئلة):**
- سؤال عن اسم الشخصية الرئيسية أو الشخصيات
- سؤال عن المكان الذي حدثت فيه القصة
- سؤال عن حدث مهم مذكور في القصة
- سؤال عن شيء فعله أحد الشخصيات
- سؤال عن نتيجة أو نهاية القصة

**تنسيق الإجابة المطلوب بالضبط:**
1. [سؤال محدد عن معلومة مذكورة في القصة]
أ. [خيار مرتبط بالقصة]
ب. [خيار مرتبط بالقصة]
ج. [خيار مرتبط بالقصة]
د. [خيار مرتبط بالقصة]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

2. [سؤال آخر عن معلومة مختلفة من القصة]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

3. [سؤال ثالث]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

4. [سؤال رابع]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

5. [سؤال خامس]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

**مثال على سؤال صحيح:**
إذا كانت القصة تقول: "ذهب أحمد إلى المدرسة في الصباح"
1. أين ذهب أحمد؟
أ. إلى البيت
ب. إلى المدرسة ✓
ج. إلى الحديقة
د. إلى السوق
الإجابة الصحيحة: ب

تأكد من أن كل سؤال يمكن الإجابة عليه من خلال قراءة القصة فقط، وأن الإجابة الصحيحة موجودة حرفياً في النص.
            `.trim()
        } else {
            // Retry attempts: simpler, more direct prompt
            prompt = `
اقرأ القصة التالية:

${story}

أنشئ بالضبط ٥ أسئلة بسيطة عن القصة. كل سؤال يجب أن يكون عن معلومة مذكورة بوضوح في النص.

**قواعد مهمة:**
- أنشئ بالضبط ٥ أسئلة
- كل إجابة صحيحة يجب أن تكون مذكورة في القصة
- لا تخترع معلومات

استخدم هذا التنسيق بالضبط:

1. [سؤال بسيط عن القصة]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

2. [سؤال آخر]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

3. [سؤال ثالث]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

4. [سؤال رابع]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

5. [سؤال خامس]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

تأكد من أن الإجابة الصحيحة موجودة في القصة.
            `.trim()
        }

        const res = await fetch('https://api.fanar.qa/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${FANAR_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'Fanar-S-1-7B',
                messages: [{ role: 'user', content: prompt }],
                temperature: attempt === 1 ? 0.7 : 0.3, // Lower temperature for retries
                max_tokens: 1200
            })
        })

        const json = await res.json()
        const content = json.choices?.[0]?.message?.content?.trim() ?? ''
        return NextResponse.json({ questions: content })

    }
    catch (err)
    {
        console.error(err)
        return NextResponse.json({ error: 'MCQ generation failed' }, { status: 500 })
    }
}