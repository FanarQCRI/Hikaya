import { NextRequest, NextResponse } from 'next/server'
const FANAR_KEY = process.env.FANAR_API_KEY!

export async function POST(req: NextRequest)
{
    try
    {
        const { story, attempt = 1 } = await req.json()

        // Use different prompts based on attempt number
        let prompt: string
        
        if (attempt === 1) {
            // First attempt: comprehensive and strict prompt
            prompt = `
اقرأ القصة العربية التالية بعناية شديدة:

${story}

أنشئ بالضبط ٥ أسئلة اختيار من متعدد باللغة العربية. كل سؤال يجب أن يكون عن معلومة مذكورة بوضوح وحرفياً في القصة.

**قواعد صارمة جداً:**
1. أنشئ بالضبط ٥ أسئلة - لا أكثر ولا أقل
2. كل سؤال يجب أن يكون عن معلومة موجودة نصياً وحرفياً في القصة
3. الإجابة الصحيحة يجب أن تكون مذكورة حرفياً في القصة - لا تقم بتخمين أو استنتاج
4. جميع الخيارات الخاطئة يجب أن تكون منطقية ولكن خاطئة بوضوح ومذكورة في القصة أو قريبة من السياق
5. لا تخترع أي معلومات غير موجودة في القصة
6. لا تسأل عن معلومات عامة أو خارج القصة
7. ركز على الحقائق المذكورة صراحةً: الأسماء، الأماكن، الأحداث، الألوان، الأرقام، الأفعال

**أنواع الأسئلة المطلوبة (٥ أسئلة):**
- سؤال عن اسم الشخصية الرئيسية (يجب أن يكون الاسم مذكوراً حرفياً)
- سؤال عن المكان الذي حدثت فيه القصة (يجب أن يكون المكان مذكوراً حرفياً)
- سؤال عن حدث مهم مذكور في القصة (يجب أن يكون الحدث مذكوراً حرفياً)
- سؤال عن شيء فعله أحد الشخصيات (يجب أن يكون الفعل مذكوراً حرفياً)
- سؤال عن نتيجة أو نهاية القصة (يجب أن تكون النتيجة مذكورة حرفياً)

**قواعد صارمة للإجابات:**
- الإجابة الصحيحة يجب أن تكون موجودة حرفياً في النص
- الخيارات الخاطئة يجب أن تكون إما مذكورة في القصة أو قريبة من السياق
- لا تستخدم إجابات مثل "لا أعرف" أو "ربما" أو "غير مذكور"
- تأكد من أن جميع الخيارات منطقية ومتعلقة بالقصة

**تنسيق الإجابة المطلوب بالضبط:**
1. [سؤال محدد عن معلومة مذكورة حرفياً في القصة]
أ. [خيار مرتبط بالقصة ومذكور أو قريب من السياق]
ب. [خيار مرتبط بالقصة ومذكور أو قريب من السياق]
ج. [خيار مرتبط بالقصة ومذكور أو قريب من السياق]
د. [خيار مرتبط بالقصة ومذكور أو قريب من السياق]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

2. [سؤال آخر عن معلومة مختلفة مذكورة حرفياً في القصة]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

3. [سؤال ثالث عن معلومة مذكورة حرفياً في القصة]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

4. [سؤال رابع عن معلومة مذكورة حرفياً في القصة]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

5. [سؤال خامس عن معلومة مذكورة حرفياً في القصة]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

**مثال على سؤال صحيح:**
إذا كانت القصة تقول: "ذهب أحمد إلى المدرسة في الصباح الباكر"
1. متى ذهب أحمد إلى المدرسة؟
أ. في المساء
ب. في الظهر
ج. في الصباح الباكر ✓
د. في الليل
الإجابة الصحيحة: ج

**تحذير مهم:** تأكد من أن كل سؤال يمكن الإجابة عليه من خلال قراءة القصة فقط، وأن الإجابة الصحيحة موجودة حرفياً في النص. لا تخترع أي معلومات.
            `.trim()
        } else {
            // Retry attempts: even more strict and direct prompt
            prompt = `
اقرأ القصة التالية بعناية:

${story}

أنشئ بالضبط ٥ أسئلة بسيطة ومباشرة عن القصة. كل سؤال يجب أن يكون عن معلومة مذكورة بوضوح وحرفياً في النص.

**قواعد صارمة جداً:**
- أنشئ بالضبط ٥ أسئلة
- كل إجابة صحيحة يجب أن تكون مذكورة حرفياً في القصة
- لا تخترع معلومات أو تستنتج
- لا تسأل عن معلومات عامة
- ركز على الأسماء والأماكن والأحداث المذكورة صراحةً

**أنواع الأسئلة المطلوبة:**
1. سؤال عن اسم شخصية (يجب أن يكون الاسم مذكوراً)
2. سؤال عن مكان (يجب أن يكون المكان مذكوراً)
3. سؤال عن حدث (يجب أن يكون الحدث مذكوراً)
4. سؤال عن فعل (يجب أن يكون الفعل مذكوراً)
5. سؤال عن نتيجة (يجب أن تكون النتيجة مذكورة)

استخدم هذا التنسيق بالضبط:

1. [سؤال عن معلومة مذكورة حرفياً في القصة]
أ. [خيار مذكور أو قريب من السياق]
ب. [خيار مذكور أو قريب من السياق]
ج. [خيار مذكور أو قريب من السياق]
د. [خيار مذكور أو قريب من السياق]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

2. [سؤال آخر عن معلومة مذكورة حرفياً]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

3. [سؤال ثالث عن معلومة مذكورة حرفياً]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

4. [سؤال رابع عن معلومة مذكورة حرفياً]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

5. [سؤال خامس عن معلومة مذكورة حرفياً]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

تأكد من أن الإجابة الصحيحة موجودة حرفياً في القصة.
            `.trim()
        }

        const res = await fetch('https://api.fanar.qa/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${FANAR_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'Fanar-S-1-7B',
                messages: [{ role: 'user', content: prompt }],
                temperature: attempt === 1 ? 0.3 : 0.1, // Lower temperature for more consistent results
                max_tokens: 1500
            })
        })

        const json = await res.json()
        const content = json.choices?.[0]?.message?.content?.trim() ?? ''
        return NextResponse.json({ questions: content })

    }
    catch (err)
    {
        console.error(err)
        return NextResponse.json({ error: 'MCQ generation failed' }, { status: 500 })
    }
}