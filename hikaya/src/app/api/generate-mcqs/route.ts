import { NextRequest, NextResponse } from 'next/server'
const FANAR_KEY = process.env.FANAR_API_KEY!

export async function POST(req: NextRequest)
{
    try
    {
        const { story, attempt = 1, neededQuestions = 5 } = await req.json()

        let prompt: string

        if (attempt === 1) {
            prompt = `
أنت معلم عربي محترف. مهمتك إنشاء ${neededQuestions} أسئلة اختيار من متعدد بناءً على قصة أطفال عربية.

هذه القصة:

${story}

**القواعد الصارمة:**
- أنشئ بالضبط ${neededQuestions} أسئلة. لا أكثر ولا أقل.
- جميع الأسئلة يجب أن تكون عن حقائق مذكورة صراحة في القصة
- كل سؤال يجب أن يتعلق بتفصيل مذكور في القصة: أسماء، أماكن، أحداث، أفعال، نتائج
- الإجابة الصحيحة يجب أن تظهر حرفياً في القصة
- الإجابات الخاطئة يجب أن تكون منطقية ومتعلقة بالموضوع
- لا تخترع حقائق غير موجودة في القصة

**أنواع الأسئلة المطلوبة (واحد من كل نوع):**
1. سؤال عن اسم شخصية
2. سؤال عن مكان مذكور في القصة
3. سؤال عن حدث محدد
4. سؤال عن فعل قام به شخص ما
5. سؤال عن النتيجة أو نهاية القصة

**التنسيق المطلوب - استخدم هذا التنسيق بالضبط:**

1. [السؤال باللغة العربية]
أ. [الخيار الأول]
ب. [الخيار الثاني]
ج. [الخيار الثالث]
د. [الخيار الرابع]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

2. [السؤال الثاني]
أ. [الخيار الأول]
ب. [الخيار الثاني]
ج. [الخيار الثالث]
د. [الخيار الرابع]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

3. [السؤال الثالث]
أ. [الخيار الأول]
ب. [الخيار الثاني]
ج. [الخيار الثالث]
د. [الخيار الرابع]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

4. [السؤال الرابع]
أ. [الخيار الأول]
ب. [الخيار الثاني]
ج. [الخيار الثالث]
د. [الخيار الرابع]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

5. [السؤال الخامس]
أ. [الخيار الأول]
ب. [الخيار الثاني]
ج. [الخيار الثالث]
د. [الخيار الرابع]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

**مهم جداً:** اكتب باللغة العربية فقط. لا تكتب أي تعليقات أو ملاحظات أو شرح. تأكد من أن لديك بالضبط ${neededQuestions} أسئلة.
            `.trim()
        } else {
            prompt = `
أنشئ ${neededQuestions} أسئلة اختيار من متعدد بناءً على هذه القصة العربية:

${story}

**المتطلبات:**
- بالضبط ${neededQuestions} أسئلة
- الإجابة الصحيحة يجب أن تكون مذكورة حرفياً في القصة
- كل سؤال يجب أن يتعلق بشيء محدد: اسم، مكان، حدث، فعل، أو نتيجة
- جميع الإجابات يجب أن تكون منطقية وباللغة العربية فقط

**التنسيق:**

1. [السؤال]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

2. [السؤال]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

3. [السؤال]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

4. [السؤال]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

5. [السؤال]
أ. [خيار]
ب. [خيار]
ج. [خيار]
د. [خيار]
الإجابة الصحيحة: [أ أو ب أو ج أو د]

**مهم:** اكتب باللغة العربية فقط. لا تكتب أي تعليقات أو ملاحظات. تأكد من أن لديك بالضبط ${neededQuestions} أسئلة.
            `.trim()
        }

        const res = await fetch('https://api.fanar.qa/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${FANAR_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'Fanar-S-1-7B',
                messages: [{ role: 'user', content: prompt }],
                temperature: attempt === 1 ? 0.2 : 0.1,
                max_tokens: 2500 // Increased for better question generation
            })
        })

        const json = await res.json()
        const content = json.choices?.[0]?.message?.content?.trim() ?? ''
        return NextResponse.json({ questions: content })

    }
    catch (err)
    {
        console.error(err)
        return NextResponse.json({ error: 'MCQ generation failed' }, { status: 500 })
    }
}